# Agentsmd Guide

The `agentsmd` command manages AGENTS.md files across repositories using a migration-style best practices system. It creates symlinks for CLAUDE.md and GEMINI.md, generates or updates AGENTS.md files with versioned best practices, uses Claude Code to analyze repositories for project-specific content, and automatically syncs modular rule files (.mdc) to your project.

## Quick Start

```bash
# Basic usage in current directory
agentsmd

# Preview what would be done
agentsmd --check-only

# Run on a specific project
agentsmd --project ~/work/myproject

# List available migrations
agentsmd --list-migrations
```

## What Does It Do?

1. **Creates Symlinks**: Automatically creates CLAUDE.md and GEMINI.md as symlinks to AGENTS.md
2. **Applies Migrations**: Uses numbered migration files to build/update AGENTS.md content
3. **Analyzes Projects**: Uses Claude Code to generate project-specific documentation
4. **Tracks Versions**: Prevents duplicate migrations with `.agentyard-version.yml`
5. **Caches Results**: Stores Claude analysis results for performance
6. **Line Wrapping**: Automatically wraps lines to 120 characters while preserving markdown formatting
7. **Syncs Rule Files**: Automatically copies .mdc rule files to `docs/agentyard/rules/`
8. **Preserves Local Edits**: Skips syncing rules that have been locally modified

## How It Works

### Migration System

Migrations are numbered files (001-, 002-, etc.) stored in `~/agentyard/agentsmd/best-practices/`. Each migration can contain:

- **Static content**: Regular markdown that's copied as-is
- **Claude prompts**: Dynamic content generated by analyzing your project

Example migration file:
```markdown
# Description: Basic header and purpose

# AGENTS.md

## Overview

{{CLAUDE_PROMPT}}
Analyze this repository and provide a 2-3 sentence overview.
{{/CLAUDE_PROMPT}}
```

Everything between `{{CLAUDE_PROMPT}}` and `{{/CLAUDE_PROMPT}}` is sent to Claude Code, and only the response (not the prompt or markers) is included in the output.

### Version Tracking

The `.agentyard-version.yml` file tracks which migrations have been applied:

```yaml
agentsmd:
  version: 5
  applied_at: "2025-01-05T10:30:00Z"
  cache_key: "abc123"
```

### Caching

Claude analysis results are cached in `~/agentyard/agentsmd/cache/` to avoid redundant API calls. Caches are automatically invalidated when:
- The repository changes (git commit hash)
- Key project files are modified
- You use the `--no-cache` option

### Line Wrapping

After all migrations are processed, the AGENTS.md content is automatically wrapped to keep lines under 120 characters for better readability. The wrapping is intelligent and preserves:
- **Headers**: Remain on single lines regardless of length
- **Code blocks**: Content between ``` markers is never wrapped
- **Lists**: Proper indentation is maintained with continuation lines
- **URLs**: Never broken across lines even if they exceed 120 characters
- **Blockquotes**: Each wrapped line maintains the > prefix

If the `fmt` command is not available, line wrapping is skipped with a warning.

### Rule System

The rule system provides modular, standalone guidelines that complement the migration-based best practices:

#### What are Rules?
- **Rules** are .mdc (Markdown with Configuration) files containing specific guidelines
- They live in `~/agentyard/agentsmd/rules/` and are copied to `docs/agentyard/rules/` in your project
- Unlike migrations, rules are not processed - they're copied as-is
- Rules can be organized in subdirectories for categorization

#### Rule Syncing
- Rules are automatically synced when you run `agentsmd`
- The system tracks rules using `.agentyard-rules.yml` with checksums
- If you modify a rule locally, it won't be overwritten by updates
- New rules are automatically added to your project

#### Rule References
- All synced rules are referenced at the end of AGENTS.md
- References use the format: `@docs/agentyard/rules/filename.mdc`
- AI assistants can access these rules for additional guidance

#### Local Modifications
When you edit a rule file locally:
- The system detects the change via checksum comparison
- The file is skipped during future syncs
- You'll see a warning about skipped files with local modifications
- This allows project-specific customization of rules

## Command Options

| Option | Description |
|--------|-------------|
| `-h, --help` | Show help message |
| `-c, --check-only` | Preview changes without applying |
| `-v, --verbose` | Show detailed progress |
| `-n, --no-cache` | Force fresh Claude analysis |
| `-p, --project <path>` | Target specific directory |
| `-l, --list-migrations` | Show available migrations |
| `-m, --model <model>` | Claude model to use (default: sonnet) |
| `-t, --timeout <secs>` | Timeout per Claude call (default: 60) |
| `-r, --max-retries <n>` | Max retry attempts (default: 2) |
| `-s, --show-prompts` | Show prompts sent to Claude |

## Available Migrations

The default migrations include:

1. **001-header.md**: Basic header and project overview
2. **002-architecture.md**: Architecture patterns and technologies
3. **003-development-setup.md**: Setup instructions and commands
4. **004-testing-approach.md**: Testing strategy and commands
5. **005-file-roadmap.md**: Key files and coding conventions
6. **006-ai-guidelines.md**: Guidelines for AI assistants
7. **007-standards.md**: Strict coding standards and requirements

## Available Rules

The default rules include:

1. **commit.mdc**: Guidelines for creating well-formatted commit messages

## Creating Custom Migrations

To add your own migrations:

1. Create a new file in `~/agentyard/agentsmd/best-practices/`
2. Name it with a number prefix (e.g., `007-security-guidelines.md`)
3. Add a description comment: `# Description: Your description here`
4. Include static content and/or Claude prompts

Example custom migration:
```markdown
# Description: Security guidelines for the project

## Security Guidelines

{{CLAUDE_PROMPT}}
Analyze this codebase and identify:
1. Authentication/authorization patterns
2. Data validation approaches
3. Security-sensitive areas

Format as actionable guidelines.
{{/CLAUDE_PROMPT}}

### General Security Rules

- Never commit secrets or API keys
- Always validate user input
- Use parameterized queries for databases
```

## Creating Custom Rules

To add your own rule files:

1. Create a new .mdc file in `~/agentyard/agentsmd/rules/`
2. Include optional YAML frontmatter for metadata
3. Write clear, actionable guidelines
4. Optionally organize in subdirectories

Example custom rule (`~/agentyard/agentsmd/rules/testing/unit-tests.mdc`):
```markdown
---
description: Unit testing guidelines and best practices
tags: [testing, quality]
---

# Unit Testing Guidelines

## Test Structure
- Use descriptive test names that explain what is being tested
- Follow the Arrange-Act-Assert pattern
- Keep tests focused on a single behavior

## Coverage Requirements
- Maintain minimum 90% code coverage
- Test edge cases and error conditions
- Mock external dependencies
```

The rule will be automatically synced to projects and referenced in AGENTS.md.

## Troubleshooting

### Claude Code Not Found

If you get an error about Claude Code not being found:
```bash
npm install -g @anthropic-ai/claude-code
```

### Migration Already Applied

If you see "No new migrations to apply", the system is working correctly. To force re-application:
1. Delete `.agentyard-version.yml` in your project
2. Run `agentsmd` again

### Claude Analysis Failed

Common causes:
- Network connectivity issues
- Claude API rate limits
- Invalid prompts in migration files

Use `--verbose` to see detailed error messages.

### Cache Issues

To clear the cache:
```bash
rm -rf ~/agentyard/agentsmd/cache/
```

Or use `--no-cache` for a single run.

## Integration with Agentyard Workflow

The `agentsmd` command complements the agentyard workflow:

1. **Start a new task**: `starttask myproject feature/new-feature`
2. **Set up AI guidance**: `agentsmd`
3. **Work with AI assistance**: Claude/Gemini will use AGENTS.md
4. **Finish task**: `finishtask`

## Best Practices

1. **Run Early**: Run `agentsmd` when starting work on a new repository
2. **Keep Updated**: Re-run periodically to apply new migrations
3. **Review Output**: Check the generated AGENTS.md for accuracy
4. **Customize**: Add project-specific migrations for your team
5. **Version Control**: Commit `.agentyard-version.yml` with your project

## Examples

### Setting Up a New Project

```bash
cd ~/work/my-new-project
agentsmd

# Output:
# [agentsmd] Working in: /Users/you/work/my-new-project
# [agentsmd] Created symlink: CLAUDE.md -> AGENTS.md
# [agentsmd] Created symlink: GEMINI.md -> AGENTS.md
# [agentsmd] Applying migration: 001-header.md
# [agentsmd] Applying migration: 002-architecture.md
# ...
# [agentsmd] Done! AGENTS.md is now up to date.
```

### Checking What Would Be Done

```bash
agentsmd --check-only

# Output:
# [agentsmd] Working in: /Users/you/work/project
# [agentsmd] Found 2 new migration(s) to apply
# [agentsmd] Migrations that would be applied:
#   - 005-file-roadmap.md
#   - 006-ai-guidelines.md
```

### Debugging Claude Integration

```bash
agentsmd --verbose --show-prompts --no-cache

# Shows detailed output including:
# - Current version tracking
# - Claude prompts being sent
# - Cache key generation
# - API responses
```

## Advanced Usage

### Custom Model Selection

Use a different Claude model:
```bash
agentsmd --model opus
agentsmd --model "claude-3-opus-20240229"
```

### Timeout Adjustment

For large codebases that need more analysis time:
```bash
agentsmd --timeout 120  # 2 minutes per prompt
```

### Selective Migration

To see what a specific migration would add:
1. Temporarily move other migrations out of the best-practices folder
2. Run `agentsmd --check-only`
3. Restore the migrations

## Contributing

To contribute new migrations or improvements:

1. Create new migration files following the naming convention
2. Test thoroughly with various project types
3. Document any new Claude prompt patterns
4. Submit a PR to the agentyard repository

Remember: Migrations should be additive and never break existing AGENTS.md files.